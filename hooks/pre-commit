#!/bin/bash
# ============================================
# Pre-commit Hook - é˜²æ­¢æ•æ„Ÿè³‡æ–™æ´©æ¼
# å®‰è£: è¤‡è£½åˆ° .git/hooks/pre-commit
# ============================================

echo "ğŸ” æª¢æŸ¥æ•æ„Ÿè³‡æ–™..."

# æª¢æŸ¥å³å°‡æäº¤çš„æª”æ¡ˆ
FILES=$(git diff --cached --name-only --diff-filter=ACM)

# å±éšªæ¨¡å¼
DANGEROUS_PATTERNS=(
    "HKD [0-9]"      # æ¸¯å¹£é‡‘é¡
    "USD [0-9]"      # ç¾å…ƒé‡‘é¡
    "ä¿¡ç”¨å¡"         # ä¿¡ç”¨å¡è³‡è¨Š
    "å•†æˆ¶åç¨±"       # å•†å®¶åç¨±
    "äº¤æ˜“é‡‘é¡"       # äº¤æ˜“é‡‘é¡
    "ç›´æ¥æ‰£è³¬"       # æ‰£è³¬é€šçŸ¥
    "ä¿¡ç”¨å¡å°¾è™Ÿ"     # å¡è™Ÿå¾Œå››ç¢¼
    "config.json$"   # çœŸå¯¦é…ç½®æª”ï¼ˆéæ¨¡æ¿ï¼‰
)

# æª¢æŸ¥æª”æ¡ˆåç¨±
for file in $FILES; do
    # æª¢æŸ¥æ˜¯å¦ç‚ºæ•æ„Ÿæª”æ¡ˆé¡å‹
    if [[ $file == *.csv ]] || [[ $file == *.log ]] || [[ $file == raw/* ]]; then
        echo "âŒ ERROR: Detected sensitive file type: $file"
        echo "   CSV/Log/Raw files should NOT be committed!"
        exit 1
    fi
    
    # æª¢æŸ¥ config.jsonï¼ˆéæ¨¡æ¿ï¼‰
    if [[ $file == "config.json" ]] && [[ $file != *.template ]]; then
        echo "âŒ ERROR: config.json contains passwords!"
        echo "   Use config.json.template instead."
        exit 1
    fi
done

# æª¢æŸ¥æª”æ¡ˆå…§å®¹
for pattern in "${DANGEROUS_PATTERNS[@]}"; do
    MATCHES=$(git diff --cached | grep -E "$pattern" | head -5)
    if [ ! -z "$MATCHES" ]; then
        echo "âŒ ERROR: Detected sensitive pattern: $pattern"
        echo "   Matches:"
        echo "$MATCHES"
        echo ""
        echo "ğŸ’¡ é€™äº›å…§å®¹ä¸æ‡‰è©² Push åˆ° GitHubï¼"
        exit 1
    fi
done

echo "âœ… æ²’æœ‰æª¢æ¸¬åˆ°æ•æ„Ÿè³‡æ–™ï¼Œç¹¼çºŒæäº¤..."
exit 0
